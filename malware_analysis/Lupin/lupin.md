# Lupin

### Sherlock Scenario
After a security incident, unusual activity on Samira’s workstation led to the discovery of a suspicious binary operating stealthily in the background. The executable evades standard detection while maintaining persistence and network communication. Your mission is to reverse the binary and extract the attacker’s TTPs for the endpoint security team.

### Basic Static Analysis
**Generic File information**
```
md5sum.exe optimize.exe
f30fdbf3448f67cbc3566f31729cb7a6 *optimize.exe

file optimize.exe
optimize.exe: PE32 executable (GUI) Intel 80386, for MS Windows
```
**Running Strings or Floss**
- Inital section has some text, which seems encrypted to me.
```
---SNIP---
TW3wpRJmZgC5WifuY468JBUCF3TEkzBT5H
qph44jx8r9k5xeq5cuf958krv3ewrnp5vc6hhdjd3r
mona1qwdqvzuwn6qj7l9xmsfqur2vc7uda0rcpftv9ej
rsXCXBf9SagxV8JfC12d8Bybk84oPdMNN9
QaBvbNAuoU52qCgbqsgoLAbK5P21L6dn5Y
RLefLLmDAZZb5ZynfPMjZ475pQdHVZNz9J
NASUHUTM7J5HNOJVZ2EULOP6INPNPSE4KN6AQNRI
via1qs8zt7jr4sgru6r8dqtdpc93c5d8wmwu8rkz94z
H42AN3K4hbqdprBnJVG8UFQzRZftKJM1EY
Wdv4zK4Fc9D2PJ9aePL9jUmdjvdQeoKV7Q
---SNIP---
```
- We can observe some bitcoin related things.
```
ronin:a77fa3ea6e09a5f3fbfcb2a42fe21b5cf0ecdd1a
bitcoincash:qph44jx8r9k5xeq5cuf958krv3ewrnp5vc6hhdjd3r
```
- Then we have some addresses, ssdp command, body for a request, then multiple Windows API call.
```
http://185.156.72.39/
http://45.141.233.6/

M-SEARCH * HTTP/1.1
ST:urn:schemas-upnp-org:device:InternetGatewayDevice:1
MX: 3
Man:"ssdp:discover"
HOST: 239.255.255.250:1900
%S%S
Mozilla/4.0 (compatible; UPnP/1.0; Windows 9x)

URLDownloadToFileW
urlmon.dll
DeleteUrlCacheEntry
InternetCloseHandle
InternetReadFile
```
- At end some more jumbled text which seemed like repeated text, and another part which looks just different.
```
l9n7b5f2r
257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857
257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857257952873527395927395728375987839759823798573987582379857
```

**Virustotal result**
![virus_total](VirusTotal_res.png)

**PE Studio**
![pe_studio](internet_operation_libraries.png)\
These libraries are realted with network communication. This we can relate with the addresses that we got using strings.\
We can see the entropy being high which indicates towards encryption or compression.

We can get the entropy using Detect It Easy as well.
![entropy](entropy.png)

### Basic Dynamic Analysis
- While monitoring with Procmon we can see the request for reading the `urlmon` and `wininet` dlls, similar result we observed from pestudio.

![libraries_loaded](internet_libraries_used.png)

- We also notice that the binary is creating files at locations, this indicate the copying itself. Using procmon filters we can see this filter.

![file_copy](file_create_operation.png)

- From regshot we can see that a new entry being created under the Run folder where the location is where the binary is copied. This registry is used to make a program run when a user logs in.

![regshot](regshot_res.png)

### Advanced Static Analysis
After decompiling the binary and examining the control flow and code, following is what was observed:
- At the begining we have one very weird string that is being pushed.

    ![weird_stirng](weird_offset_at_start.png)

- After this we observe two sections first is filename being compared with a defined value and then zone of the system being checked. For the filename we can see the static value is being pushed and then content is loaded in eax and that is pushed, after which a string comparison functon is called.

    ![fz3](filename_zone_3.png)
    ![fz1](filename_zone_1.png)
    ![fz2](filename_zone_2.png)

- The code tried to copy itself and then modifies the registry `Software\Microsoft\Windows\CurrectVersion\Run\Windows Settings` with value where it was able to copy itself.

![resgitry_change](registry_modification.png)

- The code flow for making a copy works as:
    - first checks `%USERPROFILE%`
    - second check `%windir%`
    - then check `%temp%`

- At offset 0x407680 a function is being called which calls the server at address http[:]//185[.]156[.]72[.]39, in this function one Win32 API is used which removes the file associated with the source name from the cache, if the file exists.\
This will allow the call to ensure that fresh data is retrieved from the C2 server.

![delete_cache](cache_delete.png)

- We know that Samira noticed something happen when she tried to paste some content, so it's possible that pasting some content is the trigger for this malware. From this we can say clipbaord is involved, for the same when we check the API which are used for clipboard we can see functions like
    - OpenClipbaord
    - CloseClipboard
    - GetClipboardData

- Based on this information we can perform a search in our decompiler and see where OpenClipboard function is being used. From this we came across two seperate function.\
One function being called by other, so from a general assumption one is the trigger function and other is the one which perform malicious task on the users machine.

- While navigating the code we came across multiple API related with clipboard, One of them `SetClipboardViewer`, this recieves a message whenever the content of the clipboard changes.\
This message is sent to the first window in the clipboard viewer chain when the content of te clipboard changes. This enables a clipboard viewer window to display the new content of the clipboard.

![message_clipboard](inidcator_for_windows_message.png)

- Inside the function which is used for modifying the content of the clipboard we can see hardcoded crypto wallet for multiple chains.

- Next we start looking for the weird address that we got at the start using strings as that looked like a multicast address, when we perform a cross reference for the same we came across the function which is being used for perfroming the `SSDP M-Search` operation.\
There are many more compared to what have been mentioned below.

```
Ronin (Axie Infinity sidechain):
ronin:a77fa3ea6e09a5f3fbfcb2a42fe21b5cf0ecdd1a

Bitcoin Cash (cashaddr / bech32 variant):
bitcoincash:qph44jx8r9k5xeq5cuf958krv3ewrnp5vc6hhdjd3r


Cosmos (bech32):
cosmos125f3mw4xd9htpsq4zj5w5ezm5gags37yj6q8sr


Cardano (bech32, Shelley format, starts with addr1):
addr1qxlwyj95fk9exqf55tdknx49e5443nr925tajatrdqpp8djla7u9jhswc3dk39se79f9zhwwq2ca95er3mylm48wyalqr62dmg


Nano (bech32-ish with custom alphabet):
nano_3p8stz4wqicgda1g3ifd48girzd5u74is8sdqq99tkuuz1b96wjwbc7yrmnb
```

![ssdp](ssdp.png)
